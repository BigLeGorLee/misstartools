<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

	<head>
		<%include("web/inc/head")%>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Misstar Tools - 小米路由器</title>
		<meta name="Copyright" content="Douco Design." />
		<meta name="viewport" content="width=1200">
		<link href="<%=resource%>/web/luci/css/public.css" rel="stylesheet" type="text/css">
		<link href="<%=resource%>/web/css/bc.css?v=<%=ver%>" rel="stylesheet">
		<link href="<%=resource%>/web/css/vpn.css?v=<%=ver%>" rel="stylesheet">

		<script type="text/javascript" src="<%=resource%>/web/luci/js/jquery.min.js"></script>
		<script type="text/javascript" src="<%=resource%>/web/luci/js/global.js"></script>
		<script type="text/javascript" src="<%=resource%>/web/luci/js/jquery.tab.js"></script>
		<script type="text/javascript" src="<%=resource%>/web/luci/js/qwrap.js"></script>
	</head>

	<body>
		<div id="doc">
			<%include("web/inc/header")%>
			<!-- dcHead 结束 -->
			<div id="start" class="start">
				<%include("web/inc/menu")%>
				<div id="dcMain">
					<!-- 当前位置 -->
					<div class="mainBox" style="height:auto!important;height:550px;min-height:550px;">
						<h3>科学上网</h3>
						<script type="text/javascript">
							$(function() {
								$(".idTabs").idTabs();
							});
						</script>
						<div class="idTabs">
							<ul class="tab">
								<li>
									<a href="#main">常规设置</a>
								</li>
								<li>
									<a href="#display">DNS突破设置</a>
								</li>
							</ul>
							<div class="items">
								<form>
									<div id="main">
										<table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
											<tr>
												<th width="131"></th>
												<th><b>Shadowsocks开关</b></th>
											</tr>
											<tr>
												<tr>
													<td align="left">SS开关</td>
													<td>
														<label for="ss_enable_1">
															<input type="radio" name="ss_enable" id="ss_enable_1" value="1" onchange="ss_change();">开启</label>
														<label for="ss_enable_0">
															<input type="radio" name="ss_enable" id="ss_enable_0" value="0" onchange="ss_change();">关闭</label>
													</td>
												</tr>
												<tr>
													<th width="131"></th>
													<th><b>SS相关配置</b></th>
												</tr>
												<tr>
													<td align="left">服务器地址</td>
													<td>
														<input type="text" id="ss_server" value="" size="80" class="inpMain" style="width: 300px;" />
													</td>
												</tr>
												<tr>
													<td align="left">服务器端口</td>
													<td>
														<input type="text" id="ss_server_port" value="" size="80" class="inpMain" style="width: 300px;" />
													</td>
												</tr>
												<tr>
													<td align="left">本地端口</td>
													<td>
														<input type="text" id="ss_local_port" value="" size="80" class="inpMain" style="width: 300px;" />
														<p class="cue">通常情况下不建议频繁对本地端口进行更改</p>
													</td>
												</tr>
												<tr>
													<td align="left">服务器密码</td>
													<td>
														<input type="password" id="ss_passwd" value="" size="80" class="inpMain" style="width: 300px;" />
													</td>
												</tr>
												<tr>
													<td align="left">加密方式</td>
													<td>
														<select id="ss_method" style="width: 300px;">
															<option value="aes-256-cfb">aes-256-cfb</option>
															<option value="aes-192-cfb">aes-192-cfb</option>
															<option value="aes-128-cfb">aes-128-cfb</option>
															<option value="table">table</option>
															<option value="rc4">rc4</option>
															<option value="rc4-md5">rc4-md5</option>
															<option value="bf-cfb">bf-cfb</option>
															<option value="camellia-128-cfb">camellia-128-cfb</option>
															<option value="camellia-192-cfb">camellia-192-cfb</option>
															<option value="camellia-256-cfb">camellia-256-cfb</option>
															<option value="cast5-cfb">cast5-cfb</option>
															<option value="des-cfb">des-cfb</option>
															<option value="idea-cfb">idea-cfb</option>
															<option value="rc2-cfb">rc2-cfb</option>
															<option value="seed-cfb">seed-cfb</option>
															<option value="salsa20">salsa20</option>
															<option value="chacha20">chacha20</option>
															<option value="chacha20-ietf">chacha20-ietf</option>
														</select>
														<p class="cue">根据服务器给的加密方式进行配置，与服务器保持一致才能正常连接。</p>
													</td>
												</tr>

												<tr>
													<td align="left">工作模式</td>
													<td>
														<select id="ss_mode">
															<option value="gfwlist">GfwList</option>
															<option value="gamemode">游戏模式</option>
															<option value="whitelist" selected>白名单</option>
															<option value="wholemode">全局模式</option>
														</select>
														<p class="cue">GfwList模式：根据PAC列表，对被屏蔽的国外IP进行加速<br> 游 戏 模 式：对国外所有IP进行UDP加速（相当于白名单+UDP）<br> 白名单 模 式：对国外所有IP进行加速<br> 全 局 模 式：所有流量都进行SS转发，可能造成国内网站访问变慢及流量消耗大，请谨慎开启</p>
													</td>
												</tr>
												<tr>
													<th width="131"></th>
													<th><b><label><input name="ssr" id="ssr" type="checkbox" value="" onclick="ssr_change();">ssr</label> </b></th>
												</tr>
												<tr>
													<td align="left">协议</td>
													<td>
														<select id="ssr_protocol" disabled="disabled" style="width: 300px;">
															<option value="origin">origin</option>
															<option value="verify_simple">verify_simple</option>
															<option value="verify_deflate">verify_deflate</option>
															<option value="verify_sha1">verify_sha1</option>
															<option value="verify_sha1_compatible">verify_sha1_compatible</option>
															<option value="auth_simple">auth_simple</option>
															<option value="auth_sha1">auth_sha1</option>
															<option value="auth_sha1_compatible">auth_sha1_compatible</option>
															<option value="auth_sha1_v2">auth_sha1_v2</option>
															<option value="auth_sha1_v2_compatible">auth_sha1_v2_compatible</option>
														</select>
													</td>
												</tr>
												<tr>
													<td align="left">混淆方式</td>
													<td>
														<select id="ssr_obfs" disabled="disabled" style="width: 300px;">
															<option value="plain">plain</option>
															<option value="http_simple">http_simple</option>
															<option value="http_simple_compatible">http_simple_compatible</option>
															<option value="http_post">http_post</option>
															<option value="http_post_compatible">http_post_compatible</option>
															<option value="tls_simple">tls_simple</option>
															<option value="tls_simple_compatible">tls_simple_compatible</option>
															<option value="random_head">random_head</option>
															<option value="random_head_compatible">random_head_compatible</option>
															<option value="tls1.0_session_auth">tls1.0_session_auth</option>
															<option value="tls1.0_session_auth_compatible">tls1.0_session_auth_compatible</option>
															<option value="tls1.2_ticket_auth">tls1.2_ticket_auth</option>
															<option value="tls1.2_ticket_auth_compatible">tls1.2_ticket_auth_compatible</option>
														</select>
													</td>
												</tr>
												<tr>
													<th width="131"></th>
													<th><b>工作状态</b></th>
												</tr>
												<tr>
													<td align="left">SS进程状态</td>
													<td>
														<p class="cue" id="ss_status">查询中....</p>
													</td>
												</tr>
												<tr>
													<td align="left">DNS解析状态</td>
													<td>
														<p class="cue" id="dns_status">查询中....</p>
													</td>
												</tr>
												<tr>
													<td align="left">说明</td>
													<td>
														<p class="cue">1：无进程请尝试重新开关一下ss</p>
														<p class="cue">2：有进程无法加速请看DNS状态，DNS状态正常则检查ss账号</p>
														<p class="cue">3：受有关地区和宽带区别的影响，部分地区可能无法突破DNS，请关注后续突破方案。</p>
													</td>
												</tr>
										</table>
									</div>
									<div id="display">
										<table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
											<tr>
												<th width="131"></th>
												<th><b>DNS设置</b></th>
											</tr>
											<tr>
												<td align="left">当前DNS工作模式</td>
												<td>
													<p class="cue" id="dns_mode"></p>
												</td>
											</tr>
											<tr>
												<td align="left">自动更新</td>
												<td>
													<label for="dns_auto_1">
															<input type="radio" name="dns_auto" id="dns_auto_1" value="1" onchange="change();" checked="true">开启</label>
													<label for="dns_auto_0">
															<input type="radio" name="dns_auto" id="dns_auto_0" value="0" onchange="change();" >关闭</label>
													<p class="cue">开启：自动定期更新PAC和白名单列表<br>关闭：不自动更新</p>
													<p class="cue">注意：如果开启自动更新，那你手动编辑将会失效</p>
													<p class="cue"><b>当前版本暂不支持手动编辑和自动更新，请等待更新</b></p>
												</td>
											</tr>
											<tr>
												<th width="131"></th>
												<th><b>PAC设置</b></th>
											</tr>
											<tr>
												<td align="left">PAC条数</td>
												<td>
													<p class="cue" id="pac_no"></p>
												</td>
											</tr>
											<tr>
												<td align="left">自定义PAC条数</td>
												<td>
													<p class="cue" id="pac_no_customize"></p>
												</td>
											</tr>
											<tr>
												<td align="left">添加自定义地址</td>
												<td>
													<input type="text" id="ss_server" value="" size="80" class="inpMain" style="width: 300px;" />
													<input type="button" id="add_pac" class="btn_submit" value="添加">
												</td>
											</tr>
											<tr>
												<td align="left">自定义PAC列表</td>
												<td>
													<table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
														<tbody id="paclist">
															<tr>
																<td class="center" colspan="2">查询中...</td>
															</tr>
														</tbody>
													</table>
													<td>
											</tr>
											<tr>
												<th width="131"></th>
												<th><b>白名单设置</b></th>
											</tr>
											<tr>
												<td align="left">白名单条数</td>
												<td>
													<p class="cue" id="whitelist_no"></p>
												</td>
											</tr>
											<tr>
												<td align="left">自定义白名单条数</td>
												<td>
													<p class="cue" id="whitelist_no_customize"></p>
												</td>
											</tr>
											<tr>
												<td align="left">添加自定义地址</td>
												<td>
													<input type="text" id="ss_server" value="" size="80" class="inpMain" style="width: 300px;" />
													<input type="button" id="add_pac" class="btn_submit" value="添加">
												</td>
											</tr>
											<tr>
												<td align="left">自定义白名单列表</td>
												<td>
													<table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
														<tbody id="whitelist">
															<tr>
																<td class="center" colspan="2">查询中...</td>
															</tr>
														</tbody>
													</table>
													<td>
											</tr>
										</table>
									</div>

									<table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
										<tr>
											<td width="131"></td>
											<td>
												<input type="hidden" name="token" value="24760807" />
												<input name="submit" class="btn_submit" type="submit" onclick="set_ssdns();" value="提交" />
												<img id="google" onload="google_load();" src="https://www.google.com.hk/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png" style="display:none;" onerror="google_err();">
											</td>
										</tr>
									</table>
								</form>
							</div>
						</div>
					</div>
				</div>
				<div class="clear"></div>
				<div id="dcFooter">
					<div id="footer">
						<div class="line"></div>
						<ul>
							版权所有 © 2013-2015 Misstar Tools，并保留所有权利。
						</ul>
					</div>
				</div>
				<!-- dcFooter 结束 -->
				<div class="clear"></div>
			</div>

		</div>
		<%include("web/inc/footer")%>
		<script type="tmpl/html" id="tplpaclist">
			{if($paclist.length > 0)} {for(var i=0; i
			< $paclist.length; i++)} <tr>
				<td>{$paclist[i].address}</td>
				<td align="center">
					<a href="javascript:del_pac('{$paclist[i].address}')">删除</a>
				</td>

				</tr>
				{/for} {else}
				<tr>
					<td colspan="2" class="center">没有设置信息</td>
				</tr>
				{/if}
		</script>
		<script type="tmpl/html" id="tplwhitelist">
			{if($whitelist.length > 0)} {for(var i=0; i
			< $paclist.length; i++)} <tr>
				<td>{$whitelist[i].address}</td>
				<td align="center">
					<a href="javascript:del_pac('{$whitelist[i].address}')">删除</a>
				</td>

				</tr>
				{/for} {else}
				<tr>
					<td colspan="2" class="center">没有设置信息</td>
				</tr>
				{/if}
		</script>
		<script>
			var googlestatus = 1;

			function change() {
				if(document.getElementById("dns_auto_1").checked == true) {
					document.getElementById("pac_edit").disabled = true;
					document.getElementById("whitelist_edit").disabled = true;
				} else {
					document.getElementById("pac_edit").disabled = false;
					document.getElementById("whitelist_edit").disabled = false;
				}
			}

			function ss_change() {
				if(document.getElementById("ss_enable_1").checked == true) {
					document.getElementById("ss_local_port").disabled = false;
					document.getElementById("ss_method").disabled = false;
					document.getElementById("ss_mode").disabled = false;
					document.getElementById("ss_passwd").disabled = false;
					document.getElementById("ss_server").disabled = false;
					document.getElementById("ss_server_port").disabled = false;
				} else {
					document.getElementById("ss_local_port").disabled = true;
					document.getElementById("ss_method").disabled = true;
					document.getElementById("ss_mode").disabled = true;
					document.getElementById("ss_passwd").disabled = true;
					document.getElementById("ss_server").disabled = true;
					document.getElementById("ss_server_port").disabled = true;
				}
			}

			function ssr_change() {
				if(document.getElementById("ssr").checked == true) {
					document.getElementById("ssr_protocol").removeAttribute("disabled");
					document.getElementById("ssr_obfs").removeAttribute("disabled");
				} else {
					document.getElementById("ssr_protocol").disabled = "disabled";
					document.getElementById("ssr_obfs").disabled = "disabled";
				}
			}

			function google_load() {
				googlestatus = 1;
			}

			function google_err() {
				googlestatus = 0;
			}

			function set_ssdns() {
				var ss_enable;
				var ss_server;
				var ss_port;
				var ss_local_port;
				var ss_passwd;
				var ss_method;
				var ss_mode;
				if(document.getElementById("ss_enable_0").checked == true) {
					ss_enable = 0;
				}
				if(document.getElementById("ss_enable_1").checked == true) {
					ss_enable = 1;
				}
				ss_server = document.getElementById("ss_server").value;
				ss_port = document.getElementById("ss_server_port").value;
				ss_local_port = document.getElementById("ss_local_port").value;
				ss_passwd = document.getElementById("ss_passwd").value;
				ss_method = document.getElementById("ss_method").value;
				ss_mode = document.getElementById("ss_mode").value;
				var xhr = $.getJSON('<%=luci.dispatcher.build_url("api", "misstar", "set_ssdns")%>', {
					ss_enable: ss_enable,
					ss_server: ss_server,
					ss_passwd: ss_passwd,
					ss_port: ss_port,
					ss_local_port: ss_local_port,
					ss_method: ss_method,
					ss_mode: ss_mode
				}, function(rsp) {
					if(rsp.code == 0) {
						location.reload(1);
					} else {
						alert(rsp.msg);
					}
				});
				return xhr;
			}
			function del_pac(address){
				alert(address);
			}
			function get_ss_status() {
				var xhr = $.getJSON('<%=luci.dispatcher.build_url("api", "misstar", "get_ssstatus")%>', {}, function(rsp) {
					if(rsp.code == 0) {
						var ss_info = rsp.ss_status;
						if(ss_info.ss_status == 1) {
							document.getElementById("ss_status").innerHTML = "未运行";
						} else if(ss_info.ss_status == 2) {
							document.getElementById("google").src = "https://www.google.com.hk/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png?" + Math.random();

							if(googlestatus == 1) {
								document.getElementById("ss_status").innerHTML = "运行中，国外网站加速成功！";
							} else {
								document.getElementById("ss_status").innerHTML = "运行中，国外网站加速失败，请检查ss账号并稍作等待！";
							}
						}

						if(ss_info.ss_dnsstatus == 0) {
							document.getElementById("dns_status").innerHTML = "DNS防污染失败！";
						} else if(ss_info.ss_dnsstatus == 1) {
							document.getElementById("dns_status").innerHTML = "DNS防污染成功。";
						}
					}
				});
				return xhr;
			}

			var modelSs = (function() {
				document.getElementById("li_ss").className = 'cur';

				function ssInfo() {
					var xhr = $.getJSON('<%=luci.dispatcher.build_url("api", "misstar", "get_ss")%>', {}, function(rsp) {
						if(rsp.code == 0) {
							var ss_info = rsp.ss_info;
							var dns_info = rsp.dns_info;
							var tpl = $('#tplpaclist').html(),
								tpldata = [];
							document.getElementById("ss_server").value = ss_info.ss_server;
							document.getElementById("ss_server_port").value = ss_info.ss_server_port;
							document.getElementById("ss_passwd").value = ss_info.ss_passwd;
							document.getElementById("ss_local_port").value = ss_info.ss_local_port;
							document.getElementById("ss_enable_" + ss_info.enable).checked = true;
							if(ss_info.enable == 0) {
								document.getElementById("ss_local_port").disabled = true;
								document.getElementById("ss_method").disabled = true;
								document.getElementById("ss_mode").disabled = true;
								document.getElementById("ss_passwd").disabled = true;
								document.getElementById("ss_server").disabled = true;
								document.getElementById("ss_server_port").disabled = true;
							}
							document.getElementById("dns_auto_0").checked = true;
							document.getElementById("dns_auto_1").checked = true;
							var select = document.getElementById("ss_method");
							for(var i = 0; i < select.options.length; i++) {
								if(select.options[i].value == ss_info.ss_method) {
									select.options[i].selected = true;
									break;
								}
							}
							var select = document.getElementById("ss_mode");
							for(var i = 0; i < select.options.length; i++) {
								if(select.options[i].value == ss_info.ss_mode) {
									select.options[i].selected = true;
									document.getElementById("dns_mode").innerHTML = select.options[i].innerHTML;
									break;
								}
							}

							document.getElementById("pac_no_customize").innerHTML = dns_info.pac_no_customize;
							document.getElementById("pac_no").innerHTML = dns_info.pac_no;
							document.getElementById("whitelist_no_customize").innerHTML = dns_info.chn_no_customize;
							document.getElementById("whitelist_no").innerHTML = dns_info.chn_no;

							if(dns_info.pac_customize.length > 0) {
								var pac_customize = dns_info.pac_customize.split('\n');
								for(var i = 0; i < pac_customize.length; i++) {
									if(pac_customize[i] != "") {
										var item = {
											address: pac_customize[i]
										}
										tpldata.push(item);
									}
								}
							}
							$('#paclist').html(tpl.tmpl({
								paclist: tpldata
							}));
							tpldata = [];
							if(dns_info.chn_list.length > 0) {
								var chn_customize = dns_info.chn_list.split('\n');
								for(var i = 0; i < chn_customize.length; i++) {
									if(chn_customize[i] != "") {
										var item = {
											address: chn_customize[i]
										}
										tpldata.push(item);
									}
								}
							}
							$('#whitelist').html(tpl.tmpl({
								paclist: tpldata
							}));

						}
					});
					return xhr;
				}

				return {
					init: function() {
						ssInfo();
					}
				}
			}());
			$(function() {
				modelSs.init();
				window.setInterval("get_ss_status()", 5000);
			});
		</script>
	</body>

</html>